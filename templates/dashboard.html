{% extends "base.html" %}

{% block content %}
  <section class="hero">
    <div class="badge">Dev playground</div>
    <p class="small-label">Linhas de operação</p>
    <h1>Fluxo rápido para testar seus tokens JWT</h1>
    <p>Conecte-se com o usuário admin, gere access & refresh tokens e veja o status do endpoint protegido em tempo real.</p>
    <div class="metrics">
      <div class="metric">
        <span>Último acesso</span>
        <strong id="status-timestamp">-</strong>
      </div>
      <div class="metric">
        <span>Token ativo</span>
        <strong id="status-token">nenhum</strong>
      </div>
    </div>
  </section>

  <section class="grid content-grid">
    <div class="card">
      <div class="badge">Passo 1</div>
      <h2>Login simplificado</h2>
      <p>Use seu e-mail cadastrado para gerar os tokens JWT diretamente do backend.</p>
      <form id="login-form">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="admin3913@globaltec.com.br" required autofocus />
        <label for="password">Senha</label>
        <input type="password" id="password" name="password" placeholder="lineops3913" required />
        <button class="primary" type="submit">Gerar tokens</button>
      </form>
      <div class="tokens">
        <p><strong>Access:</strong> <span id="token-access">-</span></p>
        <p><strong>Refresh:</strong> <span id="token-refresh">-</span></p>
      </div>
      <p class="status" id="login-status"></p>
    </div>

    <div class="card">
      <div class="badge">Passo 2</div>
      <h2>Testar rota protegida</h2>
      <p>Use o access token para invocar <span class="accent">/api/admin-only/</span> e valide o comportamento de `IsAdmin`.</p>
      <button class="primary" id="call-admin" type="button">Fazer chamada</button>
      <textarea id="response" readonly placeholder="A resposta aparece aqui depois da chamada."></textarea>
    </div>
  </section>

  <section class="card" style="margin-top: 2rem;">
    <div class="grid content-grid">
      <div>
        <p class="small-label">Documentação rápida</p>
        <ul>
          <li>/api/token/ (POST com email/senha)</li>
          <li>/api/token/refresh/ (POST com refresh token)</li>
          <li>/api/admin-only/ (GET protegido por IsAdmin)</li>
        </ul>
      </div>
      <div>
        <p class="small-label">Dicas</p>
        <p>Crie um superuser com <code>createsuperuser</code> e defina <code>role='admin'</code> para que a chamada funcione.</p>
      </div>
    </div>
  </section>

  <script>
    const loginForm = document.getElementById('login-form');
    const accessField = document.getElementById('token-access');
    const refreshField = document.getElementById('token-refresh');
    const status = document.getElementById('login-status');
    const tokenPreview = document.getElementById('status-token');
    const statusTimestamp = document.getElementById('status-timestamp');
    const responseArea = document.getElementById('response');

    const updateStatus = (token) => {
      tokenPreview.textContent = token ? `${token.slice(0, 12)}...` : 'nenhum';
      statusTimestamp.textContent = new Date().toLocaleTimeString();
    };

    const saveTokens = (payload) => {
      localStorage.setItem('access_token', payload.access);
      localStorage.setItem('refresh_token', payload.refresh);
      accessField.textContent = payload.access;
      refreshField.textContent = payload.refresh;
      updateStatus(payload.access);
    };

    loginForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(loginForm);
      const body = {
        email: formData.get('email'),
        password: formData.get('password'),
      };
      status.textContent = 'Autenticando...';

      try {
        const res = await fetch('/api/token/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const payload = await res.json();
        saveTokens(payload);
        status.textContent = 'Tokens prontos para uso.';
      } catch (error) {
        status.textContent = 'Erro ao gerar tokens: ' + error.message;
      }
    });

    document.getElementById('call-admin').addEventListener('click', async () => {
      const token = localStorage.getItem('access_token');
      if (!token) {
        responseArea.value = 'Nenhum token disponível. Gere um token primeiro.';
        return;
      }
      responseArea.value = 'Carregando...';
      try {
        const res = await fetch('/api/admin-only/', {
          method: 'GET',
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
        const data = await res.json();
        responseArea.value = JSON.stringify({ status: res.status, data }, null, 2);
      } catch (error) {
        responseArea.value = 'Erro: ' + error.message;
      }
    });
  </script>
{% endblock %}