{% extends "base/base.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Linha de Operacoes{% endblock %}

{% block content %}
<section class="operations-grid reveal-group">
    <div class="surface-card reveal-item">
        <div class="section-header d-flex justify-content-between align-items-center">
            <div>
                <h2>Painel de Excecoes</h2>
                <p class="text-muted mb-0">Itens prioritarios para acao imediata.</p>
            </div>
        </div>
        <div class="exception-grid mt-3">
            {% for card in exception_cards %}
                <article class="exception-card severity-{{ card.level }}">
                    <p class="exception-title">{{ card.title }}</p>
                    <p class="exception-value metric-mono">{{ card.value }}</p>
                    <p class="exception-description">{{ card.description }}</p>
                    <a href="{{ card.action_url }}" class="btn btn-sm btn-outline-light">{{ card.action_label }}</a>
                </article>
            {% endfor %}
        </div>
    </div>

    <aside class="surface-card reveal-item">
        <h2 class="h5 mb-2">Ranking por Unidade</h2>
        <p class="text-muted mb-3">Ordenado por maior volume sem numero novo.</p>
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Unidade</th>
                        <th class="text-end">Sem novo</th>
                        <th class="text-end">Reconectar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in unit_ranking %}
                        <tr>
                            <td>{{ item.unidade }}</td>
                            <td class="text-end metric-mono">{{ item.precisa_numero_novo }}</td>
                            <td class="text-end metric-mono">{{ item.reconectar_whats }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted">Sem dados de ranking.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </aside>
</section>

<section class="surface-card reveal-item trend-panel">
    <div class="section-header d-flex justify-content-between align-items-center mb-2">
        <div>
            <h2>Tendencia de 7 dias</h2>
            <p class="text-muted mb-0">Evolucao dos indicadores operacionais.</p>
        </div>
    </div>
    <div class="trend-grid">
        {% for trend in trend_series %}
            <article class="trend-card">
                <p class="trend-title">{{ trend.label }}</p>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong class="metric-mono">
                        {{ trend.latest|floatformat:1 }}{{ trend.suffix }}
                    </strong>
                    <span class="trend-delta {% if trend.delta >= 0 %}is-up{% else %}is-down{% endif %}">
                        {{ trend.delta|floatformat:1 }}
                    </span>
                </div>
                <canvas
                    class="trend-canvas"
                    width="320"
                    height="72"
                    data-trend-canvas
                    data-trend-key="{{ trend.key }}"
                    aria-label="Grafico {{ trend.label }}"
                ></canvas>
            </article>
        {% endfor %}
    </div>
</section>

<section class="table-stack reveal-group">
    <div class="surface-card reveal-item">
        <h2 class="h5 mb-3">Indicadores Diarios</h2>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Pessoas Logadas</th>
                        <th>% sem Whats</th>
                        <th>B2B sem Whats</th>
                        <th>B2C sem Whats</th>
                        <th>Numeros Disponiveis</th>
                        <th>Numeros Entregues</th>
                        <th>Reconectados</th>
                        <th>Novos</th>
                        <th>Total Descoberto DIA</th>
                    </tr>
                </thead>
                <tbody>
                    {% if indicadores_diarios and indicadores_diarios|length > 0 %}
                        {% for item in indicadores_diarios %}
                            <tr>
                                <td>{{ item.data|date:"d/m/Y" }}</td>
                                <td class="metric-mono">{{ item.pessoas_logadas|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.perc_sem_whats|floatformat:2 }}%</td>
                                <td class="metric-mono">{{ item.b2b_sem_whats|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.b2c_sem_whats|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.numeros_disponiveis|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.numeros_entregues|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.reconectados|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.novos|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.total_descoberto_dia|floatformat:0 }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="10" class="text-center text-muted">Nenhum indicador disponivel para o dia.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="surface-card reveal-item">
        <h2 class="h5 mb-3">Reconexao por Segmento e Unidade (B2B)</h2>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Unidade</th>
                        <th>Negociadores Logados</th>
                        <th>Reconectar Whats</th>
                        <th>Precisa de numero novo</th>
                    </tr>
                </thead>
                <tbody>
                    {% if reconexao_data and reconexao_data|length > 0 %}
                        {% for item in reconexao_data %}
                            <tr>
                                <td>{{ item.unidade }}</td>
                                <td class="metric-mono">{{ item.negociadores_logados }}</td>
                                <td class="metric-mono">{{ item.reconectar_whats }}</td>
                                <td class="metric-mono">{{ item.precisa_numero_novo }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">Nenhum dado de reconexao disponivel.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</section>

{{ trend_points|json_script:"trend-points" }}
{% endblock %}
