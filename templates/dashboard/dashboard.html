{% extends "base/base.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Linha de Operacoes{% endblock %}
{% block top_kpi %}98%{% endblock %}

{% block content %}
<section class="kpi-grid reveal-group">
    <article class="metric-card reveal-item">
        <p class="metric-label">Usuarios ativos</p>
        <h2 class="metric-value metric-mono" data-live-metric data-base="{{ total_employees|default:0 }}">{{ total_employees|default:0 }}</h2>
    </article>
    <article class="metric-card reveal-item">
        <p class="metric-label">Linhas totais</p>
        <h2 class="metric-value metric-mono" data-live-metric data-base="{{ total_lines|default:0 }}">{{ total_lines|default:0 }}</h2>
    </article>
    <article class="metric-card reveal-item">
        <p class="metric-label">Linhas alocadas</p>
        <h2 class="metric-value metric-mono" data-live-metric data-base="{{ allocated_lines|default:0 }}">{{ allocated_lines|default:0 }}</h2>
    </article>
    <article class="metric-card reveal-item">
        <p class="metric-label">Disponiveis</p>
        <h2 class="metric-value metric-mono" data-live-metric data-base="{{ available_lines|default:0 }}">{{ available_lines|default:0 }}</h2>
    </article>
</section>

<section class="dashboard-layout reveal-group">
    <div class="flow-canvas reveal-item" aria-label="Fluxo de linhas">
        <header class="section-header">
            <h2>Flow Canvas</h2>
            <p class="text-muted mb-0">Selecione uma linha para inspecionar logs e desempenho.</p>
        </header>
        <div class="flow-list" role="list">
            {% for status in line_status_counts %}
                <button
                    type="button"
                    class="line-card"
                    role="listitem"
                    data-line-select
                    data-line-label="{{ status.label }}"
                    data-line-count="{{ status.count }}"
                    data-line-health="{% cycle 93 98 88 95 %}"
                    aria-expanded="false"
                >
                    <span class="line-badge {% if status.count > 0 %}status-live{% else %}status-idle{% endif %}" aria-hidden="true"></span>
                    <span class="line-title">{{ status.label }}</span>
                    <span class="line-count metric-mono">{{ status.count }}</span>
                    <span class="line-progress">
                        <span class="line-progress-bar" style="width: {% widthratio status.count total_lines|default:1 100 %}%;" data-live-progress></span>
                    </span>
                </button>
            {% empty %}
                <p class="text-muted mb-0">Nenhuma linha encontrada no inventario.</p>
            {% endfor %}
        </div>
    </div>

    <aside id="line-inspector" class="line-inspector reveal-item" aria-live="polite" aria-label="Inspector tecnico">
        <button type="button" class="inspector-close" data-close-inspector aria-label="Fechar painel">
            <i class="bi bi-x-lg"></i>
        </button>
        <h3 class="inspector-title" data-inspector-label>Selecione uma linha</h3>
        <p class="inspector-subtitle">Status tecnico em tempo real</p>

        <div class="inspector-block">
            <span>Quantidade</span>
            <strong class="metric-mono" data-inspector-count>0</strong>
        </div>
        <div class="inspector-block">
            <span>Saude operacional</span>
            <strong class="metric-mono" data-inspector-health>0%</strong>
        </div>
        <div class="inspector-block">
            <span>Latencia media</span>
            <strong class="metric-mono" data-inspector-latency>0 ms</strong>
        </div>

        <div class="inspector-log">
            <p class="log-title">Logs recentes</p>
            <ul class="log-list" data-inspector-logs>
                <li>Aguardando selecao de linha...</li>
            </ul>
        </div>
    </aside>
    <button type="button" class="inspector-backdrop" data-inspector-backdrop aria-label="Fechar inspector"></button>
</section>

<section class="table-stack reveal-group">
    <div class="surface-card reveal-item">
        <h2 class="h5 mb-3">Indicadores Diarios</h2>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Pessoas Logadas</th>
                        <th>% sem Whats</th>
                        <th>B2B sem Whats</th>
                        <th>B2C sem Whats</th>
                        <th>Numeros Disponiveis</th>
                        <th>Numeros Entregues</th>
                        <th>Reconectados</th>
                        <th>Novos</th>
                        <th>Total Descoberto DIA</th>
                    </tr>
                </thead>
                <tbody>
                    {% if indicadores_diarios and indicadores_diarios|length > 0 %}
                        {% for item in indicadores_diarios %}
                            <tr>
                                <td>{{ item.data|date:"d/m/Y" }}</td>
                                <td class="metric-mono">{{ item.pessoas_logadas|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.perc_sem_whats|floatformat:2 }}%</td>
                                <td class="metric-mono">{{ item.b2b_sem_whats|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.b2c_sem_whats|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.numeros_disponiveis|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.numeros_entregues|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.reconectados|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.novos|floatformat:0 }}</td>
                                <td class="metric-mono">{{ item.total_descoberto_dia|floatformat:0 }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="10" class="text-center text-muted">Nenhum indicador disponivel para o dia.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="surface-card reveal-item">
        <h2 class="h5 mb-3">Reconexao por Segmento e Unidade (B2B)</h2>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Unidade</th>
                        <th>Negociadores Logados</th>
                        <th>Reconectar Whats</th>
                        <th>Precisa de numero novo</th>
                    </tr>
                </thead>
                <tbody>
                    {% if reconexao_data and reconexao_data|length > 0 %}
                        {% for item in reconexao_data %}
                            <tr>
                                <td>{{ item.unidade }}</td>
                                <td class="metric-mono">{{ item.negociadores_logados }}</td>
                                <td class="metric-mono">{{ item.reconectar_whats }}</td>
                                <td class="metric-mono">{{ item.precisa_numero_novo }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">Nenhum dado de reconexao disponivel.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}
