{% extends "base/base.html" %}

{% block title %}Cadastro{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h2 class="mb-1">Cadastro</h2>
        <p class="text-muted mb-0">Preencha os dados do usuário</p>
    </div>
    <div class="text-end small text-muted">
        <div>Linhas disponíveis: {{ available_lines|length }}</div>
        <div>SIMcards livres: {{ available_simcards|length }}</div>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body p-4">
        <form method="post" class="row g-4 mb-0">
            {% csrf_token %}
            <input type="hidden" name="action" value="employee">

            <div class="col-12">
                <h6 class="text-uppercase text-muted small mb-2">Dados do Usuário</h6>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Nome</label>
                        {{ employee_form.full_name }}
                        {% if employee_form.full_name.errors %}
                            <div class="invalid-feedback d-block">{{ employee_form.full_name.errors|striptags }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Supervisor</label>
                        {{ employee_form.corporate_email }}
                        {% if employee_form.corporate_email.errors %}
                            <div class="invalid-feedback d-block">{{ employee_form.corporate_email.errors|striptags }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Carteira</label>
                        {{ employee_form.employee_id }}
                        {% if employee_form.employee_id.errors %}
                            <div class="invalid-feedback d-block">{{ employee_form.employee_id.errors|striptags }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Unidade</label>
                        {{ employee_form.teams }}
                        {% if employee_form.teams.errors %}
                            <div class="invalid-feedback d-block">{{ employee_form.teams.errors|striptags }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Status</label>
                        {{ employee_form.status }}
                        {% if employee_form.status.errors %}
                            <div class="invalid-feedback d-block">{{ employee_form.status.errors|striptags }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body p-4">
        <form method="post" class="row g-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="telephony">

            {% with telephony_form.line_action.value|default:'new' as line_action %}
            <div class="col-12">
                <h6 class="text-uppercase text-muted small mb-2">Dados de Telefonia</h6>

                <div class="d-flex align-items-center gap-4 mb-3 flex-wrap">
                    <span class="text-muted small">O que deseja fazer?</span>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="line_action" id="line_action_new" value="new" {% if line_action != 'existing' and line_action != 'change_status' %}checked{% endif %}>
                        <label class="form-check-label" for="line_action_new">Cadastrar nova linha</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="line_action" id="line_action_existing" value="existing" {% if line_action == 'existing' %}checked{% endif %}>
                        <label class="form-check-label" for="line_action_existing">Vincular linha disponível</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="line_action" id="line_action_change_status" value="change_status" {% if line_action == 'change_status' %}checked{% endif %}>
                        <label class="form-check-label" for="line_action_change_status">Trocar status linha</label>
                    </div>
                                <div class="row g-3 {% if line_action != 'change_status' %}d-none{% endif %}" id="section-change-status">
                                    <div class="col-md-4">
                                        <label class="form-label">Linha</label>
                                        {{ telephony_form.phone_line_status }}
                                        {% if telephony_form.phone_line_status.errors %}
                                            <div class="invalid-feedback d-block">{{ telephony_form.phone_line_status.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Novo status</label>
                                        {{ telephony_form.status_line }}
                                        {% if telephony_form.status_line.errors %}
                                            <div class="invalid-feedback d-block">{{ telephony_form.status_line.errors|striptags }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                </div>

                <div class="row g-3 {% if line_action != 'new' %}d-none{% endif %}" id="section-new-line">
                    <div class="col-md-4">
                        <label class="form-label">Linha</label>
                        {{ telephony_form.phone_number }}
                        {% if telephony_form.phone_number.errors %}
                            <div class="invalid-feedback d-block">{{ telephony_form.phone_number.errors|striptags }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">ICCID</label>
                        {{ telephony_form.iccid }}
                        {% if telephony_form.iccid.errors %}
                            <div class="invalid-feedback d-block">{{ telephony_form.iccid.errors|striptags }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Operadora</label>
                        {{ telephony_form.carrier }}
                        {% if telephony_form.carrier.errors %}
                            <div class="invalid-feedback d-block">{{ telephony_form.carrier.errors|striptags }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row g-3 {% if line_action != 'existing' %}d-none{% endif %}" id="section-existing-line">
                    <div class="col-md-4">
                        <label class="form-label">Usuário</label>
                        {{ telephony_form.employee }}
                        {% if telephony_form.employee.errors %}
                            <div class="invalid-feedback d-block">{{ telephony_form.employee.errors|striptags }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Selecione a linha disponível</label>
                        {{ telephony_form.phone_line }}
                        {% if telephony_form.phone_line.errors %}
                            <div class="invalid-feedback d-block">{{ telephony_form.phone_line.errors|striptags }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endwith %}

            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="releaseConfirmModal" tabindex="-1" aria-labelledby="releaseConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="releaseConfirmLabel">Confirmar liberação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0" data-release-label>Deseja liberar esta linha?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" data-release-confirm>Sim, liberar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}

{% block scripts %}
<script>
    (function() {
        const telephonyForm = document.querySelector('form input[name="action"][value="telephony"]')?.closest('form');
        if (!telephonyForm) return;

        const radios = telephonyForm.querySelectorAll('input[name="line_action"]');
        const newSection = telephonyForm.querySelector('#section-new-line');
        const existingSection = telephonyForm.querySelector('#section-existing-line');
        const changeStatusSection = telephonyForm.querySelector('#section-change-status');

        function syncSections() {
            const selected = telephonyForm.querySelector('input[name="line_action"]:checked');
            const value = selected ? selected.value : 'new';
            if (newSection) newSection.classList.toggle('d-none', value !== 'new');
            if (existingSection) existingSection.classList.toggle('d-none', value !== 'existing');
            if (changeStatusSection) changeStatusSection.classList.toggle('d-none', value !== 'change_status');
        }

        radios.forEach(r => r.addEventListener('change', syncSections));
        syncSections();
    })();

    (function() {
        const modalEl = document.getElementById('releaseConfirmModal');
        const labelEl = modalEl?.querySelector('[data-release-label]');
        const confirmBtn = modalEl?.querySelector('[data-release-confirm]');
        const modalInstance = modalEl && window.bootstrap?.Modal ? window.bootstrap.Modal.getOrCreateInstance(modalEl) : null;
        let pendingForm = null;

        function submitPending() {
            if (!pendingForm) return;
            pendingForm.submit();
            pendingForm = null;
        }

        function openConfirmation(form, employee, phone) {
            pendingForm = form;
            const message = employee && phone
                ? `Deseja liberar a linha ${phone} do(a) ${employee}?`
                : 'Deseja liberar esta linha?';

            if (labelEl) {
                labelEl.textContent = message;
            }

            if (modalInstance) {
                modalInstance.show();
                return;
            }

            if (window.confirm(message)) {
                submitPending();
            } else {
                pendingForm = null;
            }
        }

        document.querySelectorAll('[data-release-trigger]').forEach(button => {
            button.addEventListener('click', event => {
                event.preventDefault();
                const form = button.closest('form');
                if (!form) return;
                const employee = button.getAttribute('data-employee');
                const phone = button.getAttribute('data-phone');
                openConfirmation(form, employee, phone);
            });
        });

        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                submitPending();
                modalInstance?.hide();
            });
        }

        if (modalEl) {
            modalEl.addEventListener('hidden.bs.modal', () => {
                pendingForm = null;
            });
        }
    })();
</script>
{% endblock %}
